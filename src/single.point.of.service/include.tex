\chapter{消除服务单点}


\section{解决问题}
多个服务同时存在的情况下如何保证只有一个提供服务，其它的都是备份。涉及到的是分布式系统中如何达到共识。

\section{问题复杂度}
简单的实现都有哪些，都在什么情况下会出现问题。

\section{假设有正确的服务发现}
通过服务发现选leader，拿到lease。比如zookeeper或者etcd。新老两个服务有不同的lease，都可以往下游写，下游怎么判断选择哪一个？

如果下游是个数据系统，数据系统无法添加相应逻辑，需要所有数据使用方都知道怎么选择正确的数据源。

如果需要通过写服务来写数据系统，服务可以通过维护当前最新的lease数字来判断。但是这个服务如果在收到老请求后gc了一分钟，起来后继续处理怎么办？这时候不会去拿最新的lease。

\section{总结}
下游可以发现上游出现了脑裂。但是下游无法保证自己没有脑裂，是一个循环依赖的问题。想要解决的话需要有一个不会脑裂的服务集群。
